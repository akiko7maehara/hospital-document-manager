<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="æ›¸é¡ç®¡ç†">
    <meta name="theme-color" content="#667eea">
    <link rel="manifest" href="manifest.json">
    <title>ç—…é™¢æ›¸é¡ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ï¼ˆã‚ªãƒ•ãƒ©ã‚¤ãƒ³ç‰ˆï¼‰</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Hiragino Kaku Gothic Pro', 'Meiryo', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 25px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .header h1 {
            color: #2d3748;
            font-size: 28px;
            margin-bottom: 15px;
        }

        .role-selector {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .role-btn {
            padding: 10px 20px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.3s;
        }

        .role-btn:hover {
            background: #667eea;
            color: white;
            transform: translateY(-2px);
        }

        .role-btn.active {
            background: #667eea;
            color: white;
        }

        .calendar-container {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .calendar-header {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 25px;
        }

        .calendar-title {
            font-size: 24px;
            font-weight: bold;
            color: #2d3748;
        }

        .calendar-nav {
            display: flex;
            gap: 10px;
        }

        .nav-btn {
            padding: 8px 16px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.3s;
        }

        .nav-btn:hover {
            background: #667eea;
            color: white;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 10px;
        }

        .calendar-day-header {
            text-align: center;
            padding: 10px;
            font-weight: bold;
            color: #4a5568;
            font-size: 14px;
        }

        .calendar-day {
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            min-height: 100px;
            padding: 8px;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }

        .calendar-day:hover {
            border-color: #667eea;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }

        .calendar-day.other-month {
            background: #f7fafc;
            opacity: 0.5;
        }

        .calendar-day.today {
            border-color: #667eea;
            background: #ebf4ff;
        }

        .calendar-day.past-day {
            background: #fff5f5;
            border-color: #fc8181;
        }

        .calendar-day.past-day .task-count {
            background: #e53e3e;
        }

        .day-number {
            font-size: 16px;
            font-weight: bold;
            color: #2d3748;
            margin-bottom: 5px;
        }

        .day-tasks {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            margin-top: 8px;
        }

        .task-badge {
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
            white-space: nowrap;
        }

        .task-emergency {
            background: #fed7d7;
            color: #742a2a;
        }

        .task-discharge-summary {
            background: #feebc8;
            color: #7c2d12;
        }

        .task-referral {
            background: #bee3f8;
            color: #2c5282;
        }

        .task-dpc {
            background: #e9d8fd;
            color: #553c9a;
        }

        .task-dpc-confirm {
            background: #d6bcfa;
            color: #44337a;
        }

        .task-count {
            position: absolute;
            top: 5px;
            right: 5px;
            background: #fc8181;
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }

        .legend {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid #e2e8f0;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            overflow-y: auto;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            max-width: 800px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            margin: 20px;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e2e8f0;
        }

        .modal-title {
            font-size: 22px;
            color: #2d3748;
            font-weight: bold;
        }

        .close-btn {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: none;
            background: #e2e8f0;
            color: #4a5568;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .close-btn:hover {
            background: #cbd5e0;
        }

        .task-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .task-item {
            background: #f7fafc;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            padding: 15px;
            transition: all 0.3s;
        }

        .task-item:hover {
            border-color: #cbd5e0;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        }

        .task-item.overdue {
            border-color: #fc8181;
            background: #fff5f5;
        }

        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .task-patient {
            font-size: 16px;
            font-weight: bold;
            color: #2d3748;
        }

        .task-type {
            font-size: 14px;
            color: #4a5568;
            margin-bottom: 5px;
        }

        .task-deadline {
            font-size: 13px;
            color: #718096;
        }

        .task-deadline.urgent {
            color: #c53030;
            font-weight: bold;
        }

        .status-toggle {
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
            border: none;
            transition: all 0.3s;
        }

        .status-completed {
            background: #c6f6d5;
            color: #22543d;
        }

        .status-pending {
            background: #fed7d7;
            color: #742a2a;
        }

        .status-in-progress {
            background: #feebc8;
            color: #7c2d12;
        }

        .status-toggle:hover {
            transform: scale(1.05);
        }

        .add-patient-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            font-size: 32px;
            cursor: pointer;
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .add-patient-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.6);
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-label {
            display: block;
            margin-bottom: 5px;
            color: #4a5568;
            font-size: 14px;
            font-weight: 500;
        }

        .form-input {
            width: 100%;
            padding: 10px;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            font-size: 14px;
        }

        .form-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
        }

        .btn-secondary {
            background: #e2e8f0;
            color: #4a5568;
        }

        .btn-secondary:hover {
            background: #cbd5e0;
        }

        .task-info {
            font-size: 13px;
            color: #718096;
            margin-top: 8px;
        }

        @media (max-width: 1024px) {
            .calendar-grid {
                gap: 5px;
            }
            
            .calendar-day {
                min-height: 80px;
                padding: 5px;
            }
            
            .task-badge {
                font-size: 10px;
                padding: 2px 6px;
            }
        }

        @media (max-width: 768px) {
            .calendar-grid {
                grid-template-columns: 1fr;
            }
            
            .calendar-day-header {
                display: none;
            }
            
            .calendar-day {
                display: flex;
                justify-content: space-between;
                align-items: center;
                min-height: 60px;
            }
            
            .day-tasks {
                flex-direction: row;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¥ ç—…é™¢æ›¸é¡ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </h1>
            <div class="role-selector" id="roleSelector">
                <button class="role-btn active" data-role="doctor">åŒ»å¸«</button>
                <button class="role-btn" data-role="medical-assistant">ãƒ¡ãƒ‡ã‚£ã‚«ãƒ«ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ</button>
                <button class="role-btn" data-role="nursing-director">çœ‹è­·éƒ¨é•·</button>
                <button class="role-btn" data-role="medical-affairs">åŒ»äº‹èª²</button>
                <button class="role-btn" data-role="medical-information">è¨ºç™‚æƒ…å ±å£«</button>
            </div>
        </div>

        <div class="calendar-container">
            <div class="calendar-header">
                <h2 class="calendar-title" id="calendarTitle">2025å¹´2æœˆ9æ—¥ ã€œ 3æœˆ1æ—¥</h2>
            </div>

            <div class="calendar-grid" id="calendarGrid"></div>

            <div class="legend">
                <div class="legend-item">
                    <div class="legend-color task-emergency"></div>
                    <span>ç·Šæ€¥ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆï¼ˆ24æ™‚é–“ä»¥å†…ï¼‰</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color task-dpc"></div>
                    <span>DPCå…¥åŠ›ï¼ˆå…¥é™¢å¾Œ7æ—¥ä»¥å†…ï¼‰</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color task-referral"></div>
                    <span>è¨ºæ–­æ›¸ãƒ»è¨ºç™‚æƒ…å ±æä¾›æ›¸ï¼ˆé€€é™¢æ—¥æœã¾ã§ï¼‰</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color task-discharge-summary"></div>
                    <span>é€€é™¢ã‚µãƒãƒªï¼ˆé€€é™¢å¾Œ3æ—¥ä»¥å†…ï¼‰</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color task-dpc-confirm"></div>
                    <span>DPCå†ç¢ºèªï¼ˆé€€é™¢å‰ï¼‰</span>
                </div>
            </div>
        </div>
    </div>

    <button class="add-patient-btn" id="addPatientBtn">+</button>

    <!-- æ—¥ä»˜è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal" id="dayDetailModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="modalTitle">2025å¹´2æœˆ11æ—¥ã®æ›¸é¡</h3>
                <button class="close-btn" id="closeDayDetail">Ã—</button>
            </div>
            <div class="task-list" id="taskList"></div>
        </div>
    </div>

    <!-- æ‚£è€…è¿½åŠ ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal" id="addPatientModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">æ–°è¦æ‚£è€…ç™»éŒ²</h3>
                <button class="close-btn" id="closeAddPatient">Ã—</button>
            </div>
            <form id="addPatientForm">
                <div class="form-group">
                    <label class="form-label">æ‚£è€…å</label>
                    <input type="text" class="form-input" id="patientName" required>
                </div>
                <div class="form-group">
                    <label class="form-label">æ‚£è€…ID</label>
                    <input type="text" class="form-input" id="patientId" required>
                </div>
                <div class="form-group">
                    <label class="form-label">å…¥é™¢æ—¥</label>
                    <input type="date" class="form-input" id="admissionDate" required>
                </div>
                <div class="form-group">
                    <label class="form-label">é€€é™¢äºˆå®šæ—¥ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰</label>
                    <input type="date" class="form-input" id="dischargeDate">
                </div>
                <div class="form-group">
                    <label class="form-label">æ‹…å½“åŒ»å¸«</label>
                    <input type="text" class="form-input" id="doctorName" required>
                </div>
                <div class="btn-group">
                    <button type="submit" class="btn btn-primary">ç™»éŒ²</button>
                    <button type="button" class="btn btn-secondary" id="cancelAddPatient">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // ãƒ‡ãƒ¼ã‚¿æ§‹é€ 
        let patients = [
            {
                id: 'P001',
                name: 'å±±ç”° å¤ªéƒ',
                admissionDate: '2025-02-08',
                dischargeDate: '2025-02-15',
                doctor: 'ç”°ä¸­åŒ»å¸«',
                documents: {
                    'ç·Šæ€¥ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ': 'completed',
                    'DPCå…¥åŠ›': 'completed',
                    'è¨ºæ–­æ›¸': 'in-progress',
                    'è¨ºç™‚æƒ…å ±æä¾›æ›¸': 'pending',
                    'é€€é™¢ã‚µãƒãƒª': 'pending',
                    'DPCå†ç¢ºèª': 'pending'
                }
            },
            {
                id: 'P002',
                name: 'ä½è—¤ èŠ±å­',
                admissionDate: '2025-02-10',
                dischargeDate: '2025-02-17',
                doctor: 'ç”°ä¸­åŒ»å¸«',
                documents: {
                    'ç·Šæ€¥ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ': 'completed',
                    'DPCå…¥åŠ›': 'in-progress',
                    'è¨ºæ–­æ›¸': 'pending',
                    'è¨ºç™‚æƒ…å ±æä¾›æ›¸': 'pending',
                    'é€€é™¢ã‚µãƒãƒª': 'pending',
                    'DPCå†ç¢ºèª': 'pending'
                }
            },
            {
                id: 'P003',
                name: 'éˆ´æœ¨ ä¸€éƒ',
                admissionDate: '2025-02-05',
                dischargeDate: '2025-02-12',
                doctor: 'å±±æœ¬åŒ»å¸«',
                documents: {
                    'ç·Šæ€¥ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ': 'completed',
                    'DPCå…¥åŠ›': 'completed',
                    'è¨ºæ–­æ›¸': 'completed',
                    'è¨ºç™‚æƒ…å ±æä¾›æ›¸': 'in-progress',
                    'é€€é™¢ã‚µãƒãƒª': 'pending',
                    'DPCå†ç¢ºèª': 'pending'
                }
            },
            {
                id: 'P004',
                name: 'é«˜æ©‹ ç¾å’²',
                admissionDate: '2025-02-11',
                dischargeDate: null,
                doctor: 'ç”°ä¸­åŒ»å¸«',
                documents: {
                    'ç·Šæ€¥ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ': 'in-progress',
                    'DPCå…¥åŠ›': 'pending',
                    'è¨ºæ–­æ›¸': 'pending',
                    'è¨ºç™‚æƒ…å ±æä¾›æ›¸': 'pending',
                    'é€€é™¢ã‚µãƒãƒª': 'pending',
                    'DPCå†ç¢ºèª': 'pending'
                }
            },
            {
                id: 'P005',
                name: 'ä¼Šè—¤ å¥å¤ª',
                admissionDate: '2025-02-09',
                dischargeDate: '2025-02-16',
                doctor: 'å±±æœ¬åŒ»å¸«',
                documents: {
                    'ç·Šæ€¥ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ': 'completed',
                    'DPCå…¥åŠ›': 'completed',
                    'è¨ºæ–­æ›¸': 'in-progress',
                    'è¨ºç™‚æƒ…å ±æä¾›æ›¸': 'pending',
                    'é€€é™¢ã‚µãƒãƒª': 'pending',
                    'DPCå†ç¢ºèª': 'in-progress'
                }
            }
        ];

        let currentRole = 'doctor';
        const today = new Date(2025, 1, 11); // 2025å¹´2æœˆ11æ—¥
        
        // è¡¨ç¤ºæœŸé–“ã®è¨ˆç®—ï¼ˆå…ˆé€±æ—¥æ›œæ—¥ã‹ã‚‰3é€±é–“å¾Œã¾ã§ï¼‰
        function getCalendarStartDate() {
            const startDate = new Date(today);
            // å…ˆé€±ã®æ—¥æ›œæ—¥ã‚’æ±‚ã‚ã‚‹ï¼ˆä»Šæ—¥ã®æ›œæ—¥ + 7æ—¥å‰ã«æˆ»ã£ã¦ã€ãã“ã‹ã‚‰æ—¥æ›œæ—¥ã‚’æ¢ã™ï¼‰
            const dayOfWeek = startDate.getDay();
            const daysToLastSunday = dayOfWeek + 7;
            startDate.setDate(startDate.getDate() - daysToLastSunday);
            return startDate;
        }
        
        function getCalendarEndDate() {
            const endDate = new Date(today);
            // 3é€±é–“å¾Œã®åœŸæ›œæ—¥
            const dayOfWeek = endDate.getDay();
            const daysToThirdSaturday = (6 - dayOfWeek) + 21;
            endDate.setDate(endDate.getDate() + daysToThirdSaturday);
            return endDate;
        }

        // å½¹å‰²ã”ã¨ã®æ‹…å½“æ›¸é¡ã‚’å®šç¾©
        const roleDocuments = {
            'doctor': ['ç·Šæ€¥ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ', 'DPCå…¥åŠ›', 'è¨ºæ–­æ›¸', 'è¨ºç™‚æƒ…å ±æä¾›æ›¸', 'é€€é™¢ã‚µãƒãƒª', 'DPCå†ç¢ºèª'],
            'medical-assistant': ['è¨ºæ–­æ›¸', 'è¨ºç™‚æƒ…å ±æä¾›æ›¸', 'é€€é™¢ã‚µãƒãƒª'],
            'nursing-director': ['ç·Šæ€¥ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ'],
            'medical-affairs': ['ç·Šæ€¥ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ'],
            'medical-information': ['DPCå…¥åŠ›', 'DPCå†ç¢ºèª']
        };

        // å½¹å‰²ãŒè¤‡æ•°ã®åŒ»å¸«ã‚’è¦‹ã‚‹ã‹ã©ã†ã‹
        const roleViewsMultipleDoctors = {
            'doctor': false,
            'medical-assistant': true,
            'nursing-director': true,
            'medical-affairs': true,
            'medical-information': true
        };

        // æ—¥ä»˜è¨ˆç®—é–¢æ•°
        function addDays(date, days) {
            const result = new Date(date);
            result.setDate(result.getDate() + days);
            return result;
        }

        function formatDate(date) {
            return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
        }

        function parseDate(dateStr) {
            return new Date(dateStr);
        }

        // æ›¸é¡ã®æœŸé™ã‚’è¨ˆç®—
        function getDeadlines(patient) {
            const admissionDate = parseDate(patient.admissionDate);
            const dischargeDate = patient.dischargeDate ? parseDate(patient.dischargeDate) : null;
            
            const deadlines = {};
            
            // ç·Šæ€¥ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ: å…¥é™¢å¾Œ24æ™‚é–“ä»¥å†…
            deadlines['ç·Šæ€¥ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ'] = formatDate(addDays(admissionDate, 1));
            
            // DPCå…¥åŠ›: å…¥é™¢å¾Œ7æ—¥ä»¥å†…
            deadlines['DPCå…¥åŠ›'] = formatDate(addDays(admissionDate, 7));
            
            if (dischargeDate) {
                // è¨ºæ–­æ›¸: é€€é™¢æ—¥ã¾ã§ï¼ˆè¨ºç™‚æƒ…å ±æä¾›æ›¸ã¨åŒã˜ã‚¿ã‚¤ãƒŸãƒ³ã‚°ï¼‰
                deadlines['è¨ºæ–­æ›¸'] = formatDate(dischargeDate);
                
                // è¨ºç™‚æƒ…å ±æä¾›æ›¸: é€€é™¢æ—¥ã®æœã¾ã§
                deadlines['è¨ºç™‚æƒ…å ±æä¾›æ›¸'] = formatDate(dischargeDate);
                
                // é€€é™¢ã‚µãƒãƒª: é€€é™¢å¾Œ3æ—¥ä»¥å†…
                deadlines['é€€é™¢ã‚µãƒãƒª'] = formatDate(addDays(dischargeDate, 3));
                
                // DPCå†ç¢ºèª: é€€é™¢å‰ï¼ˆé€€é™¢æ—¥ã®å‰æ—¥ã¾ã§ï¼‰
                deadlines['DPCå†ç¢ºèª'] = formatDate(addDays(dischargeDate, -1));
            }
            
            return deadlines;
        }

        // ã‚¿ã‚¹ã‚¯ã‚’æ—¥ä»˜ã”ã¨ã«æ•´ç†
        function getTasksByDate() {
            const tasksByDate = {};
            
            // å½¹å‰²ã«å¿œã˜ã¦æ‚£è€…ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
            let relevantPatients = patients;
            if (currentRole === 'doctor') {
                // åŒ»å¸«ã¯è‡ªåˆ†ã®æ‹…å½“æ‚£è€…ã®ã¿ï¼ˆã“ã“ã§ã¯ç”°ä¸­åŒ»å¸«ã¨ã—ã¦è¡¨ç¤ºï¼‰
                relevantPatients = patients.filter(p => p.doctor === 'ç”°ä¸­åŒ»å¸«');
            }
            // ãã®ä»–ã®å½¹å‰²ã¯å…¨æ‚£è€…ã‚’è¡¨ç¤º
            
            // å½¹å‰²ã«å¿œã˜ãŸæ‹…å½“æ›¸é¡ã‚’å–å¾—
            const allowedDocuments = roleDocuments[currentRole] || [];
            
            relevantPatients.forEach(patient => {
                const deadlines = getDeadlines(patient);
                
                Object.entries(deadlines).forEach(([docType, deadline]) => {
                    // ã“ã®å½¹å‰²ãŒæ‹…å½“ã™ã‚‹æ›¸é¡ã‹ãƒã‚§ãƒƒã‚¯
                    if (!allowedDocuments.includes(docType)) {
                        return;
                    }
                    
                    if (patient.documents[docType] !== 'completed') {
                        if (!tasksByDate[deadline]) {
                            tasksByDate[deadline] = [];
                        }
                        
                        tasksByDate[deadline].push({
                            patient: patient,
                            type: docType,
                            deadline: deadline,
                            status: patient.documents[docType]
                        });
                    }
                });
            });
            
            return tasksByDate;
        }

        // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®æç”»
        function renderCalendar() {
            const grid = document.getElementById('calendarGrid');
            const title = document.getElementById('calendarTitle');
            
            const startDate = getCalendarStartDate();
            const endDate = getCalendarEndDate();
            
            // ã‚¿ã‚¤ãƒˆãƒ«ã‚’æœŸé–“è¡¨ç¤ºã«å¤‰æ›´
            const startMonth = startDate.getMonth() + 1;
            const startDay = startDate.getDate();
            const endMonth = endDate.getMonth() + 1;
            const endDay = endDate.getDate();
            title.textContent = `${startDate.getFullYear()}å¹´${startMonth}æœˆ${startDay}æ—¥ ã€œ ${endMonth}æœˆ${endDay}æ—¥`;
            
            const tasksByDate = getTasksByDate();
            
            let html = '';
            
            // æ›œæ—¥ãƒ˜ãƒƒãƒ€ãƒ¼
            const dayNames = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
            dayNames.forEach(day => {
                html += `<div class="calendar-day-header">${day}</div>`;
            });
            
            // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®æ—¥ä»˜ã‚’ç”Ÿæˆ
            const currentDate = new Date(startDate);
            
            while (currentDate <= endDate) {
                const dateStr = formatDate(currentDate);
                const tasks = tasksByDate[dateStr] || [];
                const isToday = dateStr === formatDate(today);
                const isPast = currentDate < today && !isToday;
                
                const taskCount = tasks.length;
                
                // è¤‡æ•°ã®åŒ»å¸«ã‚’è¦‹ã‚‹å½¹å‰²ã®å ´åˆã¯ã€æ‚£è€…å+åŒ»å¸«åã‚’è¡¨ç¤º
                const showDoctorName = roleViewsMultipleDoctors[currentRole];
                
                const taskBadges = tasks.slice(0, 3).map(task => {
                    let badgeClass = 'task-badge ';
                    if (task.type === 'ç·Šæ€¥ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ') badgeClass += 'task-emergency';
                    else if (task.type === 'é€€é™¢ã‚µãƒãƒª') badgeClass += 'task-discharge-summary';
                    else if (task.type === 'è¨ºç™‚æƒ…å ±æä¾›æ›¸') badgeClass += 'task-referral';
                    else if (task.type === 'DPCå…¥åŠ›') badgeClass += 'task-dpc';
                    else if (task.type === 'DPCå†ç¢ºèª') badgeClass += 'task-dpc-confirm';
                    else if (task.type === 'è¨ºæ–­æ›¸') badgeClass += 'task-referral';
                    
                    const displayName = showDoctorName ? 
                        `${task.patient.name.split(' ')[0]}(${task.patient.doctor.replace('åŒ»å¸«', '')})` :
                        task.patient.name.split(' ')[0];
                    
                    return `<div class="${badgeClass}">${displayName}</div>`;
                }).join('');
                
                const dayOfMonth = currentDate.getDate();
                const month = currentDate.getMonth() + 1;
                
                html += `
                    <div class="calendar-day ${isToday ? 'today' : ''} ${isPast ? 'past-day' : ''}" onclick="showDayDetail('${dateStr}')">
                        <div class="day-number">${month}/${dayOfMonth}</div>
                        ${taskCount > 0 ? `<div class="task-count">${taskCount}</div>` : ''}
                        <div class="day-tasks">${taskBadges}</div>
                    </div>
                `;
                
                currentDate.setDate(currentDate.getDate() + 1);
            }
            
            grid.innerHTML = html;
        }

        // æ—¥ä»˜è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
        function showDayDetail(dateStr) {
            const tasksByDate = getTasksByDate();
            const tasks = tasksByDate[dateStr] || [];
            
            if (tasks.length === 0) return;
            
            const modal = document.getElementById('dayDetailModal');
            const title = document.getElementById('modalTitle');
            const taskList = document.getElementById('taskList');
            
            const date = parseDate(dateStr);
            title.textContent = `${date.getFullYear()}å¹´${date.getMonth() + 1}æœˆ${date.getDate()}æ—¥ã®æ›¸é¡ï¼ˆ${tasks.length}ä»¶ï¼‰`;
            
            const taskDateObj = new Date(dateStr);
            const isOverdue = taskDateObj < today;
            
            // è¤‡æ•°ã®åŒ»å¸«ã‚’è¦‹ã‚‹å½¹å‰²ã‹ã©ã†ã‹
            const showDoctorName = roleViewsMultipleDoctors[currentRole];
            
            taskList.innerHTML = tasks.map(task => {
                const statusText = task.status === 'pending' ? 'æœªç€æ‰‹' : 
                                 task.status === 'in-progress' ? 'ä½œæˆä¸­' : 'å®Œäº†';
                const statusClass = `status-${task.status}`;
                
                return `
                    <div class="task-item ${isOverdue ? 'overdue' : ''}">
                        <div class="task-header">
                            <div>
                                <div class="task-patient">${task.patient.name} (${task.patient.id})${showDoctorName ? ` - æ‹…å½“: ${task.patient.doctor}` : ''}</div>
                                <div class="task-type">${task.type}</div>
                                <div class="task-deadline ${isOverdue ? 'urgent' : ''}">
                                    æœŸé™: ${task.deadline} ${isOverdue ? 'âš ï¸ æœŸé™è¶…é' : ''}
                                </div>
                                <div class="task-info">å…¥é™¢æ—¥: ${task.patient.admissionDate}</div>
                                ${task.patient.dischargeDate ? `<div class="task-info">é€€é™¢äºˆå®š: ${task.patient.dischargeDate}</div>` : ''}
                            </div>
                            <button class="status-toggle ${statusClass}" 
                                    onclick="toggleTaskStatus('${task.patient.id}', '${task.type}')">
                                ${statusText}
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
            
            modal.classList.add('show');
        }

        // ã‚¿ã‚¹ã‚¯ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®åˆ‡ã‚Šæ›¿ãˆ
        function toggleTaskStatus(patientId, docType) {
            const patient = patients.find(p => p.id === patientId);
            if (!patient) return;
            
            const statuses = ['pending', 'in-progress', 'completed'];
            const currentStatus = patient.documents[docType];
            const currentIndex = statuses.indexOf(currentStatus);
            const nextIndex = (currentIndex + 1) % statuses.length;
            
            patient.documents[docType] = statuses[nextIndex];
            
            // ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
            saveData();
            
            // ç¾åœ¨ã®ãƒ¢ãƒ¼ãƒ€ãƒ«ã®æ—¥ä»˜ã‚’å–å¾—ã—ã¦å†è¡¨ç¤º
            const modalTitle = document.getElementById('modalTitle').textContent;
            const dateMatch = modalTitle.match(/(\d{4})å¹´(\d{1,2})æœˆ(\d{1,2})æ—¥/);
            if (dateMatch) {
                const year = dateMatch[1];
                const month = String(dateMatch[2]).padStart(2, '0');
                const day = String(dateMatch[3]).padStart(2, '0');
                const dateStr = `${year}-${month}-${day}`;
                
                renderCalendar();
                showDayDetail(dateStr);
            }
        }

        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        document.getElementById('roleSelector').addEventListener('click', (e) => {
            if (e.target.classList.contains('role-btn')) {
                document.querySelectorAll('.role-btn').forEach(btn => btn.classList.remove('active'));
                e.target.classList.add('active');
                currentRole = e.target.dataset.role;
                renderCalendar();
            }
        });

        document.getElementById('closeDayDetail').addEventListener('click', () => {
            document.getElementById('dayDetailModal').classList.remove('show');
        });

        document.getElementById('addPatientBtn').addEventListener('click', () => {
            document.getElementById('addPatientModal').classList.add('show');
            document.getElementById('addPatientForm').reset();
            document.getElementById('admissionDate').valueAsDate = new Date();
        });

        document.getElementById('closeAddPatient').addEventListener('click', () => {
            document.getElementById('addPatientModal').classList.remove('show');
        });

        document.getElementById('cancelAddPatient').addEventListener('click', () => {
            document.getElementById('addPatientModal').classList.remove('show');
        });

        document.getElementById('addPatientModal').addEventListener('click', (e) => {
            if (e.target.id === 'addPatientModal') {
                document.getElementById('addPatientModal').classList.remove('show');
            }
        });

        document.getElementById('dayDetailModal').addEventListener('click', (e) => {
            if (e.target.id === 'dayDetailModal') {
                document.getElementById('dayDetailModal').classList.remove('show');
            }
        });

        document.getElementById('addPatientForm').addEventListener('submit', (e) => {
            e.preventDefault();
            
            const newPatient = {
                id: document.getElementById('patientId').value,
                name: document.getElementById('patientName').value,
                admissionDate: document.getElementById('admissionDate').value,
                dischargeDate: document.getElementById('dischargeDate').value || null,
                doctor: document.getElementById('doctorName').value,
                documents: {
                    'ç·Šæ€¥ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ': 'pending',
                    'DPCå…¥åŠ›': 'pending',
                    'è¨ºæ–­æ›¸': 'pending',
                    'è¨ºç™‚æƒ…å ±æä¾›æ›¸': 'pending',
                    'é€€é™¢ã‚µãƒãƒª': 'pending',
                    'DPCå†ç¢ºèª': 'pending'
                }
            };
            
            patients.push(newPatient);
            
            // ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
            saveData();
            
            document.getElementById('addPatientModal').classList.remove('show');
            renderCalendar();
        });

        // ãƒ‡ãƒ¼ã‚¿ã®æ°¸ç¶šåŒ–ï¼ˆlocalStorageï¼‰
        function saveData() {
            try {
                localStorage.setItem('hospital-patients', JSON.stringify(patients));
                localStorage.setItem('hospital-last-save', new Date().toISOString());
            } catch (e) {
                console.log('ãƒ‡ãƒ¼ã‚¿ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }

        function loadData() {
            try {
                const saved = localStorage.getItem('hospital-patients');
                if (saved) {
                    patients = JSON.parse(saved);
                    console.log('ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ');
                }
            } catch (e) {
                console.log('ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }

        // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
        loadData();

        // åˆæœŸè¡¨ç¤º
        renderCalendar();
    </script>
</body>
</html>
